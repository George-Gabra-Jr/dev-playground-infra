# name: pipelines

services:
  registry:
    container_name: registry
    image: registry:2
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 1
      placement: 
        constraints: 
          - node.role == manager
      restart_policy:
        condition: any
    ports:
      - 127.0.0.1:5000:5000
    volumes:
      - registry_data:/var/lib/registry
    networks:
      cicd:
        aliases:
          - registry

  docker-dind:
    container_name: docker-dind
    image: docker:dind
    privileged: true
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 1
      placement: 
        constraints: 
          - node.role == manager
      restart_policy:
        condition: any
    volumes:
      - dind_certs:/certs/client
      - dind_data:/var/lib/docker
      - ./daemon.json:/etc/docker/daemon.json
    environment:
      DOCKER_TLS_CERTDIR: /certs
    command: ["--storage-driver", "overlay2"]
    networks:
      cicd:
        aliases:
          - docker

  jenkins:
    container_name: jenkins
    image: jenkinswithdocker:latest
    build:
      context: .
      dockerfile: Dockerfile.jenkins
    user: root
    privileged: true
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 1
      placement: 
        constraints: 
          - node.role == manager
      restart_policy:
        condition: any
    volumes:
      - jenkins_home:/var/jenkins_home
      - dind_data:/var/dind_home
      - dind_certs:/certs/client:ro
    environment:
      DOCKER_HOST: tcp://docker:2376
      DOCKER_CERT_PATH: /certs/client
      DOCKER_TLS_VERIFY: 1
    networks:
      cicd:
        aliases:
          - jenkins
      traefik-net:
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jenkins.rule=Host(`jenkins.dev-playground.net`)"
      - "traefik.http.routers.jenkins.middlewares=default-middlewares@file"
      - "traefik.http.services.jenkins.loadbalancer.server.port=8080"
      - "traefik.docker.network=traefik-net"


  portainer:
    container_name: portainer
    image: portainer/portainer-ce:latest
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 1
      placement: 
        constraints: 
          - node.role == manager
      restart_policy:
        condition: any
    volumes:
      - portainer_data:/data
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      traefik-net:
      cicd:
        aliases:
          - portainer

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=Host(`portainer.dev-playground.net`)"
      - "traefik.http.routers.portainer.middlewares=default-middlewares@file"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"
      - "traefik.docker.network=traefik-net"


  sonarqube:
    container_name: sonarqube
    image: sonarqube:community
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 1
      placement: 
        constraints: 
          - node.role == manager
      restart_policy:
        condition: any
    volumes:
      - sonarqube_data:/opt/sonarqube/
    environment:
      SONAR_JDBC_URL: jdbc:postgresql://sonarqube-db:5432/sonar
      SONAR_JDBC_USERNAME: sonar
      SONAR_JDBC_PASSWORD: sonar
    networks:
      traefik-net:
      cicd:
        aliases:
          - sonarqube
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sonarqube.rule=Host(`sonarqube.dev-playground.net`)"
      - "traefik.http.routers.sonarqube.middlewares=default-middlewares@file"
      - "traefik.http.services.sonarqube.loadbalancer.server.port=9000"
      - "traefik.docker.network=traefik-net"
    depends_on:
      - sonarqube-db

  sonarqube-db:
    container_name: sonarqube-db
    image: postgres:15
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 1
      placement: 
        constraints: 
          - node.role == manager
      restart_policy:
        condition: any
    volumes:
      - sonarqube_db:/var/lib/postgresql
    environment:
      POSTGRES_USER: sonar
      POSTGRES_PASSWORD: sonar
    networks:
      cicd:
        aliases:
          - sonarqube-db

networks:
  cicd:
    external: true
  traefik-net:
    external: true

volumes:
  registry_data:
  dind_certs:
  dind_data:
  jenkins_home:
  portainer_data:
  sonarqube_data:
  sonarqube_db:
